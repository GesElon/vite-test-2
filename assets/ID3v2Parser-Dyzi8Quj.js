import{U as w,N as G,D as V,y as Y,k as b,O as N,P as I,e as T,b as U,Q as j,R as F,V as z,A as K,m as Z,d as Q,G as q,K as J,W as X,c as y}from"./index-C0-kEXo_.js";const P={len:16,get:(n,e)=>{const t=w.get(n,e+8),a=w.get(n,e+12);return{startTime:w.get(n,e),endTime:w.get(n,e+4),startOffset:t===4294967295?void 0:t,endOffset:a===4294967295?void 0:a}}};function M(n){switch(n){case 2:return 6;case 3:case 4:return 10;default:throw B(n)}}function _(n){return{status:{tag_alter_preservation:b(n,0,6),file_alter_preservation:b(n,0,5),read_only:b(n,0,4)},format:{grouping_identity:b(n,1,7),compression:b(n,1,3),encryption:b(n,1,2),unsynchronisation:b(n,1,1),data_length_indicator:b(n,1,0)}}}function W(n,e,t){switch(e){case 2:return A(n,e,t);case 3:case 4:return ee(n,e,t);default:throw B(e)}}function A(n,e,t){const a={id:V(n.subarray(0,3),"ascii"),length:Y.get(n,3)};return a.id.match(/^[A-Z0-9]{3}$/)||t.addWarning(`Invalid ID3v2.${e} frame-header-ID: ${a.id}`),a}function ee(n,e,t){const a={id:V(n.subarray(0,4),"ascii"),length:(e===4?G:w).get(n,4),flags:_(n.subarray(8,10))};return a.id.match(/^[A-Z0-9]{4}$/)||t.addWarning(`Invalid ID3v2.${e} frame-header-ID: ${a.id}`),a}function B(n){throw new E(`Unexpected majorVer: ${n}`)}const $=Q("music-metadata:id3v2:frame-parser"),u="latin1",L={encoding:u,bom:!1};function te(n){const e=[];let t,a="";for(const i of n)if(typeof t=="string")if(i==="("&&t==="")a+="(",t=void 0;else if(i===")"){a!==""&&(e.push(a),a="");const r=R(t);r&&e.push(r),t=void 0}else t+=i;else i==="("?t="":a+=i;return a&&(e.length===0&&a.match(/^\d*$/)&&(a=R(a)),a&&e.push(a)),e}function R(n){if(n==="RX")return"Remix";if(n==="CR")return"Cover";if(n.match(/^\d*$/))return q[Number.parseInt(n,10)]}class l{constructor(e,t){this.major=e,this.warningCollector=t}readData(e,t,a){if(e.length===0){this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${t}`);return}const{encoding:i,bom:r}=N.get(e,0),h=e.length;let d=0,o=[];const f=l.getNullTerminatorLength(i);let g;switch($(`Parsing tag type=${t}, encoding=${i}, bom=${r}`),t!=="TXXX"&&t[0]==="T"?"T*":t){case"T*":case"GRP1":case"IPLS":case"MVIN":case"MVNM":case"PCS":case"PCST":{let s;try{s=l.trimNullPadding(T(e.subarray(1),i))}catch(c){if(c instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${t} header has invalid string value: ${c.message}`);break}throw c}switch(t){case"TMCL":case"TIPL":case"IPLS":o=l.functionList(this.splitValue(t,s));break;case"TRK":case"TRCK":case"TPOS":case"TIT1":case"TIT2":case"TIT3":o=s;break;case"TCOM":case"TEXT":case"TOLY":case"TOPE":case"TPE1":case"TSRC":o=this.splitValue(t,s);break;case"TCO":case"TCON":o=this.splitValue(t,s).map(c=>te(c)).reduce((c,m)=>c.concat(m),[]);break;case"PCS":case"PCST":o=this.major>=4?this.splitValue(t,s):[s],o=Array.isArray(o)&&o[0]===""?1:0;break;default:o=this.major>=4?this.splitValue(t,s):[s]}break}case"TXXX":{const s=l.readIdentifierAndData(e.subarray(1),i);o={description:s.id,text:this.splitValue(t,T(s.data,i).replace(/\x00+$/,""))};break}case"PIC":case"APIC":if(a){const s={};switch(e=e.subarray(1),this.major){case 2:s.format=T(e.subarray(0,3),"latin1"),e=e.subarray(3);break;case 3:case 4:g=I(e,u),s.format=T(e.subarray(0,g),u),e=e.subarray(g+1);break;default:throw ae(this.major)}s.format=l.fixPictureMimeType(s.format),s.type=K[e[0]],e=e.subarray(1),g=I(e,i),s.description=T(e.subarray(0,g),i),e=e.subarray(g+f),s.data=e,o=s}break;case"CNT":case"PCNT":o=j(e);break;case"SYLT":{const s=z.get(e,0);e=e.subarray(z.len);const c={descriptor:"",language:s.language,contentType:s.contentType,timeStampFormat:s.timeStampFormat,syncText:[]};let m=!1;for(;e.length>0;){const p=l.readNullTerminatedString(e,s.encoding);if(e=e.subarray(p.len),m){const k=w.get(e,0);e=e.subarray(w.len),c.syncText.push({text:p.text,timestamp:k})}else c.descriptor=p.text,m=!0}o=c;break}case"ULT":case"USLT":case"COM":case"COMM":{const s=F.get(e,d);d+=F.len;const c=l.readNullTerminatedString(e.subarray(d),s.encoding);d+=c.len;const m=l.readNullTerminatedString(e.subarray(d),s.encoding);o={language:s.language,descriptor:c.text,text:m.text};break}case"UFID":{const s=l.readIdentifierAndData(e,u);o={owner_identifier:s.id,identifier:s.data};break}case"PRIV":{const s=l.readIdentifierAndData(e,u);o={owner_identifier:s.id,data:s.data};break}case"POPM":{e=e.subarray(d);const s=l.readNullTerminatedString(e,L),c=s.text;if(e=e.subarray(s.len),e.length===0){this.warningCollector.addWarning(`id3v2.${this.major} type=${t} POPM frame missing rating byte`),o={email:c,rating:0,counter:void 0};break}const m=U.get(e,0),p=e.subarray(U.len);o={email:c,rating:m,counter:p.length>0?j(p):void 0};break}case"GEOB":{const s=N.get(e,0);e=e.subarray(1);const c=l.readNullTerminatedString(e,L),m=c.text;e=e.subarray(c.len);const p=l.readNullTerminatedString(e,s),k=p.text;e=e.subarray(p.len);const S=l.readNullTerminatedString(e,s),v=S.text;e=e.subarray(S.len),o={type:m,filename:k,description:v,data:e};break}case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":o=l.readNullTerminatedString(e,L).text;break;case"WXXX":{const s=N.get(e,0);e=e.subarray(1);const c=l.readNullTerminatedString(e,s),m=c.text;e=e.subarray(c.len),o={description:m,url:l.trimNullPadding(T(e,u))};break}case"WFD":case"WFED":{const s=N.get(e,0);e=e.subarray(1),o=l.readNullTerminatedString(e,s).text;break}case"MCDI":{o=e.subarray(0,h);break}case"CHAP":{$("Reading CHAP"),g=I(e,u);const s={label:T(e.subarray(0,g),u),info:P.get(e,g+1),frames:new Map};for(d+=g+1+P.len;d<h;){const c=W(e.subarray(d),this.major,this.warningCollector),m=M(this.major);d+=m;const p=this.readData(e.subarray(d,d+c.length),c.id,a);d+=c.length,s.frames.set(c.id,p)}o=s;break}case"CTOC":{$("Reading CTOC");const s=I(e,u),c=T(e.subarray(0,s),u);d=s+1;const m=e[d++],p=(m&2)!==0,k=(m&1)!==0,S=e[d++],v=[];for(let x=0;x<S&&d<h;x++){const D=I(e.subarray(d),u),O=T(e.subarray(d,d+D),u);v.push(O),d+=D+1}const H={label:c,flags:{topLevel:p,ordered:k},childElementIds:v,frames:new Map};for(;d<h;){const x=W(e.subarray(d),this.major,this.warningCollector),D=M(this.major);d+=D;const O=this.readData(e.subarray(d,d+x.length),x.id,a);d+=x.length,H.frames.set(x.id,O)}o=H;break}default:$(`Warning: unsupported id3v2-tag-type: ${t}`);break}return o}static readNullTerminatedString(e,t){const a=t.bom?2:0,i=e.length,r=e.subarray(a),h=I(r,t.encoding);if(h>=r.length)return{text:T(r,t.encoding),len:i};const d=r.subarray(0,h);return{text:T(d,t.encoding),len:a+h+l.getNullTerminatorLength(t.encoding)}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase(),e){case"jpg":return"image/jpeg";case"png":return"image/png"}return e}static functionList(e){const t={};for(let a=0;a+1<e.length;a+=2){const i=e[a+1].split(",");t[e[a]]=t[e[a]]?t[e[a]].concat(i):i}return t}splitValue(e,t){let a;return this.major<4?(a=t.split(/\x00/g),a.length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${e} uses non standard null-separator.`):a=t.split(/\//g)):a=t.split(/\x00/g),l.trimArray(a)}static trimArray(e){return e.map(t=>l.trimNullPadding(t).trim())}static trimNullPadding(e){let t=e.length;for(;t>0&&e.charCodeAt(t-1)===0;)t--;return t===e.length?e:e.slice(0,t)}static readIdentifierAndData(e,t){const a=l.readNullTerminatedString(e,{encoding:t,bom:!1});return{id:a.text,data:e.subarray(a.len)}}static getNullTerminatorLength(e){return e.startsWith("utf-16")?2:1}}class E extends Z("id3v2"){}function ae(n){throw new E(`Unexpected majorVer: ${n}`)}class C{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,a=0;for(;t<e.length-1;)t!==a&&(e[a]=e[t]),t+=e[t]===255&&e[t+1]===0?2:1,a++;return t<e.length&&(e[a++]=e[t]),e.subarray(0,a)}static readFrameData(e,t,a,i,r){const h=new l(a,r);switch(a){case 2:return h.readData(e,t.id,i);case 3:case 4:return t.flags?.format.unsynchronisation&&(e=C.removeUnsyncBytes(e)),t.flags?.format.data_length_indicator&&(e=e.subarray(4,e.length)),h.readData(e,t.id,i);default:throw se(a)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:"")}async parse(e,t,a){this.tokenizer=t,this.metadata=e,this.options=a;const i=await this.tokenizer.readToken(J);if(i.fileIdentifier!=="ID3")throw new E("expected ID3-header file-identifier 'ID3' was not found");this.id3Header=i,this.headerType=`ID3v2.${i.version.major}`,await(i.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(i.size));const r=C.mapId3v2Chapters(this.metadata.native[this.headerType]);this.metadata.setFormat("chapters",r)}async parseExtendedHeader(){const e=await this.tokenizer.readToken(X),t=e.size-X.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)}async parseExtendedHeaderData(e,t){return await this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)}async parseId3Data(e){const t=await this.tokenizer.readToken(new y(e));for(const a of this.parseMetadata(t))a.id==="TXXX"?a.value&&await this.handleTag(a,a.value.text,()=>a.value.description):await(Array.isArray(a.value)?Promise.all(a.value.map(i=>this.addTag(a.id,i))):this.addTag(a.id,a.value))}async handleTag(e,t,a,i=r=>r){await Promise.all(t.map(r=>this.addTag(C.makeDescriptionTagName(e.id,a(r)),i(r))))}async addTag(e,t){await this.metadata.addTag(this.headerType,e,t)}parseMetadata(e){let t=0;const a=[];for(;t!==e.length;){const i=M(this.id3Header.version.major);if(t+i>e.length){this.metadata.addWarning("Illegal ID3v2 tag length");break}const r=e.subarray(t,t+i);t+=i;const h=W(r,this.id3Header.version.major,this.metadata),d=e.subarray(t,t+h.length);t+=h.length;const o=C.readFrameData(d,h,this.id3Header.version.major,!this.options.skipCovers,this.metadata);o&&a.push({id:h.id,value:o})}return a}static mapId3v2Chapters(e){if(!e)return;const t=e.filter(f=>f.id==="CHAP");if(!t?.length)return;const i=e.filter(f=>f.id==="CTOC")?.find(f=>f.value.flags?.topLevel),r=new Map;for(const f of t)r.set(f.value.label,f.value);const h=i?.value.childElementIds,d=[],o=h??[...r.keys()];for(const f of o){const g=r.get(f);if(!g)continue;const s=g.frames,c=s.get("TIT2");c&&d.push({id:f,title:c,url:s.get("WXXX"),start:g.info.startTime/1e3,end:g.info.endTime/1e3,image:s.get("APIC")})}return h||d.sort((f,g)=>f.start-g.start),d.length?d:void 0}}function se(n){throw new E(`Unexpected majorVer: ${n}`)}export{C as I};
